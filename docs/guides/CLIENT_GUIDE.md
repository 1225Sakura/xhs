# Electron客户端部署和使用指南

## 📋 目录
1. [系统架构说明](#系统架构说明)
2. [客户端安装](#客户端安装)
3. [客户端配置](#客户端配置)
4. [连接云端服务](#连接云端服务)
5. [功能使用](#功能使用)
6. [故障排查](#故障排查)

---

## 系统架构说明

本项目采用**云端+本地双系统架构**：

```
┌─────────────────────────────────────────────────────────────┐
│                      云端监控系统                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  - PostgreSQL（客户端数据、许可证、指标）            │  │
│  │  - EMQX MQTT（实时通信）                             │  │
│  │  - Prometheus + Grafana（监控可视化）                │  │
│  │  - React管理仪表盘（客户端管理、许可证管理）         │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↕ MQTT + HTTPS
┌─────────────────────────────────────────────────────────────┐
│                    本地Electron客户端                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  - SQLite本地数据库                                   │  │
│  │  - 小红书文案生成                                     │  │
│  │  - 知识库管理                                         │  │
│  │  - 定时发布                                           │  │
│  │  - 数据同步到云端                                     │  │
│  │  - 接收云端控制指令                                   │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 工作流程

1. **用户在本地使用Electron客户端**
   - 生成小红书文案
   - 管理知识库
   - 定时发布内容

2. **客户端自动连接云端**
   - 注册到云端服务器
   - 定期上报心跳和指标
   - 同步配置和数据

3. **管理员在云端监控**
   - 查看所有客户端状态
   - 管理许可证
   - 远程配置客户端
   - 查看使用统计

---

## 客户端安装

### 方式1: 使用预编译版本（推荐）

```bash
# 下载最新版本
# Windows: xhs-client-setup-x.x.x.exe
# macOS: xhs-client-x.x.x.dmg
# Linux: xhs-client-x.x.x.AppImage

# 运行安装程序
```

### 方式2: 从源码构建

#### 前置要求
- Node.js 20+
- npm 10+

#### 构建步骤

```bash
# 克隆代码
git clone https://github.com/1225Sakura/xhs.git
cd xhs

# 安装依赖
npm install
npm install --workspace=packages/client

# 开发模式运行
npm run dev:client

# 构建生产版本
npm run build:client

# 打包成安装程序
cd packages/client
npm run package
```

构建产物位置：
- Windows: `packages/client/dist/xhs-client-setup-x.x.x.exe`
- macOS: `packages/client/dist/xhs-client-x.x.x.dmg`
- Linux: `packages/client/dist/xhs-client-x.x.x.AppImage`

---

## 客户端配置

### 首次启动配置

1. **启动客户端**
   - 双击运行安装好的应用

2. **输入许可证密钥**
   ```
   许可证格式: XXXX-XXXX-XXXX-XXXX-XXXX
   ```
   - 从管理员处获取许可证密钥
   - 输入后点击"激活"

3. **配置云端服务器地址**
   ```
   服务器地址: https://your-domain.com
   MQTT地址: mqtt://your-domain.com:1883
   ```

4. **配置DeepSeek API**
   ```
   API密钥: sk-your-deepseek-api-key
   ```

5. **设置知识库路径**
   ```
   选择本地知识库文件夹
   ```

### 配置文件位置

客户端配置存储在：
- Windows: `%APPDATA%/xhs-client/config.json`
- macOS: `~/Library/Application Support/xhs-client/config.json`
- Linux: `~/.config/xhs-client/config.json`

配置文件示例：
```json
{
  "server": {
    "apiUrl": "https://your-domain.com",
    "mqttUrl": "mqtt://your-domain.com:1883"
  },
  "license": {
    "key": "XXXX-XXXX-XXXX-XXXX-XXXX",
    "activated": true
  },
  "deepseek": {
    "apiKey": "sk-xxxxx"
  },
  "knowledgeBase": {
    "path": "C:\\Users\\xxx\\Documents\\知识库"
  },
  "sync": {
    "enabled": true,
    "interval": 300000
  }
}
```

---

## 连接云端服务

### 自动注册流程

客户端首次启动时会自动注册到云端：

1. **生成客户端ID**
   - 基于机器ID生成唯一标识

2. **验证许可证**
   - 向云端验证许可证密钥
   - 检查许可证是否过期
   - 检查客户端数量限制

3. **建立MQTT连接**
   - 连接到云端MQTT Broker
   - 订阅控制指令主题
   - 开始接收云端消息

4. **上报心跳**
   - 每5分钟上报一次心跳
   - 包含客户端状态、版本信息

### 连接状态指示

客户端界面右上角显示连接状态：
- 🟢 **在线** - 已连接到云端
- 🟡 **连接中** - 正在连接
- 🔴 **离线** - 未连接到云端
- ⚠️ **许可证过期** - 需要续期

---

## 功能使用

### 1. 文案生成

```
1. 点击"生成文案"按钮
2. 填写产品信息
3. 选择文案风格（种草型、教程型等）
4. 点击"生成"
5. 查看生成的文案
6. 可以编辑、保存或直接发布
```

**云端同步**：
- 生成的文案自动同步到云端
- 管理员可以在仪表盘查看使用统计

### 2. 知识库管理

```
1. 点击"知识库"标签
2. 浏览本地知识库文件
3. 支持的格式：
   - Word文档 (.docx)
   - PDF文件 (.pdf)
   - 文本文件 (.txt, .md)
   - Excel表格 (.xlsx)
4. 点击文件查看内容
5. 在生成文案时自动引用知识库
```

### 3. 定时发布

```
1. 点击"定时发布"标签
2. 添加发布任务：
   - 选择文案
   - 设置发布时间
   - 选择发布账号
3. 任务会在指定时间自动执行
4. 查看发布历史和状态
```

### 4. 数据同步

客户端自动同步以下数据到云端：
- ✅ 生成的文案数量
- ✅ API调用次数
- ✅ 发布成功/失败记录
- ✅ 客户端运行时长
- ✅ 错误日志

### 5. 接收云端控制

管理员可以从云端控制客户端：
- 📥 **推送配置更新** - 自动更新客户端配置
- 🔄 **强制同步** - 立即同步数据
- ⏸️ **暂停服务** - 临时禁用客户端
- 🔔 **发送通知** - 向客户端推送消息

---

## 故障排查

### 问题1: 无法连接到云端

**症状**：客户端显示"离线"状态

**解决方法**：
```bash
1. 检查网络连接
   - ping your-domain.com

2. 检查服务器地址配置
   - 确认API地址和MQTT地址正确

3. 检查防火墙
   - 允许客户端访问443端口（HTTPS）
   - 允许客户端访问1883端口（MQTT）

4. 查看客户端日志
   - Windows: %APPDATA%/xhs-client/logs/
   - macOS: ~/Library/Logs/xhs-client/
   - Linux: ~/.local/share/xhs-client/logs/
```

### 问题2: 许可证验证失败

**症状**：提示"许可证无效"或"许可证已过期"

**解决方法**：
```
1. 检查许可证格式
   - 确保格式为: XXXX-XXXX-XXXX-XXXX-XXXX

2. 联系管理员
   - 确认许可证是否有效
   - 检查是否超过客户端数量限制

3. 重新激活
   - 删除配置文件
   - 重新启动客户端
   - 输入新的许可证密钥
```

### 问题3: 文案生成失败

**症状**：点击生成后报错

**解决方法**：
```
1. 检查DeepSeek API配置
   - 确认API密钥正确
   - 检查API配额是否充足

2. 检查网络连接
   - 确保可以访问api.deepseek.com

3. 查看错误日志
   - 客户端日志文件中查看详细错误信息
```

### 问题4: 数据同步失败

**症状**：数据未上传到云端

**解决方法**：
```
1. 检查MQTT连接状态
   - 确认客户端显示"在线"

2. 手动触发同步
   - 点击"立即同步"按钮

3. 检查同步队列
   - 查看待同步数据数量
   - 如果队列过大，可能需要清理
```

### 问题5: 客户端崩溃

**症状**：应用突然关闭

**解决方法**：
```
1. 查看崩溃日志
   - crash.log文件

2. 清理缓存
   - 删除临时文件
   - 重新启动客户端

3. 重新安装
   - 卸载客户端
   - 下载最新版本
   - 重新安装
```

---

## 日志和调试

### 启用调试模式

```bash
# 开发模式运行（显示详细日志）
npm run dev:client

# 或设置环境变量
set DEBUG=xhs:*
xhs-client.exe
```

### 日志文件位置

- **应用日志**: `logs/app.log`
- **错误日志**: `logs/error.log`
- **同步日志**: `logs/sync.log`
- **MQTT日志**: `logs/mqtt.log`

### 导出诊断信息

```
1. 点击"帮助" -> "导出诊断信息"
2. 生成诊断报告zip文件
3. 包含：
   - 配置文件（脱敏）
   - 最近的日志
   - 系统信息
   - 连接状态
```

---

## 更新客户端

### 自动更新

客户端会自动检查更新：
```
1. 启动时检查新版本
2. 发现新版本时提示用户
3. 点击"立即更新"自动下载安装
4. 安装完成后重启客户端
```

### 手动更新

```bash
# 下载最新版本
# 运行安装程序
# 会自动覆盖旧版本，保留配置和数据
```

---

## 卸载客户端

### Windows
```
控制面板 -> 程序和功能 -> 小红书发布系统 -> 卸载
```

### macOS
```
将应用拖到废纸篓
```

### Linux
```bash
rm -rf ~/.local/share/xhs-client
rm -rf ~/.config/xhs-client
```

### 清理数据

如需完全清理所有数据：
```bash
# Windows
rmdir /s %APPDATA%\xhs-client

# macOS
rm -rf ~/Library/Application\ Support/xhs-client
rm -rf ~/Library/Logs/xhs-client

# Linux
rm -rf ~/.local/share/xhs-client
rm -rf ~/.config/xhs-client
```

---

## 安全建议

1. **保护许可证密钥**
   - 不要分享给他人
   - 定期更换密钥

2. **保护API密钥**
   - DeepSeek API密钥不要泄露
   - 定期检查API使用量

3. **定期备份**
   - 备份本地数据库
   - 备份知识库文件

4. **及时更新**
   - 保持客户端版本最新
   - 关注安全公告

---

## 技术支持

如有问题，请：
1. 查看本文档的故障排查部分
2. 导出诊断信息
3. 联系管理员或技术支持

**文档版本**: 1.0
**最后更新**: 2024-02-27
