# 系统架构总览

## 🏗️ 双系统架构

本项目采用**云端监控 + 本地客户端**的双系统架构，实现商业化SaaS服务。

```
┌─────────────────────────────────────────────────────────────────┐
│                        云端监控系统                              │
│                    （服务器端 - 管理员使用）                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  PostgreSQL  │  EMQX MQTT  │  Prometheus  │  Grafana     │  │
│  │  客户端数据  │  实时通信   │  指标收集    │  可视化      │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              React管理仪表盘                               │  │
│  │  - 客户端管理  - 许可证管理  - 用户管理  - 监控统计       │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                            ↕ HTTPS + MQTT
┌─────────────────────────────────────────────────────────────────┐
│                      本地Electron客户端                          │
│                    （桌面应用 - 终端用户使用）                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  SQLite本地库  │  文案生成  │  知识库  │  定时发布        │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              自动同步到云端                                 │  │
│  │  - 心跳上报  - 指标统计  - 数据同步  - 接收控制指令       │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📚 部署文档导航

### 1. 云端系统部署（管理员）

**文档**: [SERVER_DEPLOYMENT.md](./SERVER_DEPLOYMENT.md)

**部署内容**:
- PostgreSQL数据库
- EMQX MQTT Broker
- Node.js API服务
- Prometheus + Grafana监控
- React管理仪表盘

**部署方式**:
- ✅ Docker Compose一键部署（推荐）
- ✅ 手动部署各个服务

**适用场景**:
- 服务器管理员部署云端服务
- Ubuntu 20.04/22.04 + Docker环境

---

### 2. 本地客户端部署（终端用户）

**文档**: [CLIENT_GUIDE.md](./CLIENT_GUIDE.md)

**部署内容**:
- Electron桌面应用
- SQLite本地数据库
- 文案生成功能
- 知识库管理
- 定时发布

**部署方式**:
- ✅ 下载安装包直接安装（推荐）
- ✅ 从源码构建

**适用场景**:
- 终端用户安装使用
- Windows/macOS/Linux桌面环境

---

### 3. 本地测试环境（开发者）

**文档**: [LOCAL_TESTING.md](./LOCAL_TESTING.md)

**测试内容**:
- 第一阶段：基础架构功能测试
- 第二阶段：监控系统和管理仪表盘测试

**适用场景**:
- 开发者本地测试
- 功能验证和调试

---

## 🔄 系统交互流程

### 1. 客户端注册流程

```
1. 用户启动Electron客户端
   ↓
2. 输入许可证密钥
   ↓
3. 客户端向云端API发送注册请求
   ↓
4. 云端验证许可证（RSA签名验证）
   ↓
5. 验证通过，返回客户端ID和配置
   ↓
6. 客户端建立MQTT连接
   ↓
7. 开始定期上报心跳和指标
```

### 2. 文案生成流程

```
1. 用户在客户端填写产品信息
   ↓
2. 客户端调用DeepSeek API生成文案
   ↓
3. 生成成功，保存到本地SQLite
   ↓
4. 通过MQTT上报使用统计到云端
   ↓
5. 云端记录API调用次数和成本
   ↓
6. 管理员在仪表盘查看使用情况
```

### 3. 远程控制流程

```
1. 管理员在仪表盘发送控制指令
   ↓
2. 云端通过MQTT推送指令到客户端
   ↓
3. 客户端接收并执行指令
   ↓
4. 执行结果通过MQTT返回云端
   ↓
5. 管理员在仪表盘查看执行状态
```

### 4. 数据同步流程

```
1. 客户端本地生成数据
   ↓
2. 数据加入同步队列
   ↓
3. 每5分钟批量同步到云端
   ↓
4. 云端存储到PostgreSQL
   ↓
5. Prometheus采集指标
   ↓
6. Grafana展示可视化图表
```

---

## 🎯 功能对比

| 功能 | 云端系统 | 本地客户端 |
|------|---------|-----------|
| **用户角色** | 管理员 | 终端用户 |
| **部署位置** | 服务器 | 用户电脑 |
| **主要功能** | 监控管理 | 文案生成 |
| **客户端管理** | ✅ | ❌ |
| **许可证管理** | ✅ | ❌ |
| **用户管理** | ✅ | ❌ |
| **监控统计** | ✅ | ❌ |
| **文案生成** | ❌ | ✅ |
| **知识库管理** | ❌ | ✅ |
| **定时发布** | ❌ | ✅ |
| **数据同步** | 接收 | 上报 |
| **远程控制** | 发送指令 | 接收指令 |

---

## 📊 数据流向

### 上行数据（客户端 → 云端）

- ✅ 客户端注册信息
- ✅ 心跳数据（每5分钟）
- ✅ 使用统计（API调用、文案生成）
- ✅ 错误日志
- ✅ 性能指标

### 下行数据（云端 → 客户端）

- ✅ 配置更新
- ✅ 控制指令
- ✅ 通知消息
- ✅ 许可证状态

---

## 🔐 安全机制

### 1. 许可证验证
- RSA 2048位数字签名
- 机器ID绑定
- 过期时间检查
- 客户端数量限制

### 2. 通信加密
- HTTPS（API通信）
- MQTT over TLS（实时通信）
- JWT Token认证

### 3. 数据保护
- 本地数据库加密
- API密钥加密存储
- 敏感信息脱敏

---

## 🚀 快速开始

### 管理员（部署云端）

```bash
# 1. 克隆代码到服务器
git clone git@github.com:1225Sakura/xhs.git
cd xhs

# 2. 配置环境变量
cp .env.production .env
nano .env

# 3. 启动Docker服务
docker-compose -f docker-compose.production.yml up -d

# 4. 配置Nginx和SSL
sudo cp nginx/xhs-cloud.conf /etc/nginx/sites-available/
sudo certbot --nginx -d your-domain.com

# 5. 访问管理仪表盘
# https://your-domain.com/dashboard
```

详细步骤请参考: [SERVER_DEPLOYMENT.md](./SERVER_DEPLOYMENT.md)

### 终端用户（安装客户端）

```bash
# 1. 下载客户端安装包
# Windows: xhs-client-setup.exe
# macOS: xhs-client.dmg
# Linux: xhs-client.AppImage

# 2. 运行安装程序

# 3. 启动客户端，输入许可证密钥

# 4. 配置云端服务器地址

# 5. 开始使用
```

详细步骤请参考: [CLIENT_GUIDE.md](./CLIENT_GUIDE.md)

---

## 📈 商业化模式

### 许可证计划

| 计划 | 客户端数量 | 功能 | 价格 |
|------|-----------|------|------|
| **Trial** | 1 | 基础功能，7天试用 | 免费 |
| **Basic** | 3 | 完整功能 | ¥99/月 |
| **Pro** | 10 | 完整功能 + 优先支持 | ¥299/月 |
| **Enterprise** | 无限制 | 完整功能 + 定制开发 | 联系销售 |

### 计费方式

- 按月订阅
- 按年订阅（8折优惠）
- 按客户端数量计费
- 按API调用量计费（可选）

---

## 🛠️ 技术栈

### 云端系统
- **后端**: Node.js + Express
- **数据库**: PostgreSQL 15
- **缓存**: Redis 6
- **消息队列**: EMQX MQTT 5
- **监控**: Prometheus + Grafana
- **前端**: React 18 + TypeScript + Ant Design

### 本地客户端
- **框架**: Electron 28
- **数据库**: SQLite (better-sqlite3)
- **前端**: HTML + CSS + JavaScript
- **AI**: DeepSeek API

---

## 📞 技术支持

- **GitHub**: https://github.com/1225Sakura/xhs
- **文档**: 项目根目录各个README文件
- **Issues**: https://github.com/1225Sakura/xhs/issues

---

**文档版本**: 1.0
**最后更新**: 2024-02-27
