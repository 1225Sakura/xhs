# AI提供商配置指南

## 📋 概述

系统已配置使用您的代理API服务 `https://api.aiyunos.top`，支持7个AI提供商和12个模型。

---

## 🔑 API配置信息

### 代理服务地址
```
https://api.aiyunos.top
```

### 您的API Key
请使用您购买商品获得的 API KEY

---

## 🤖 支持的AI提供商

系统已添加以下7个提供商（按优先级排序）：

### 1. Anthropic Claude (优先级: 100)
- **API地址**: https://api.aiyunos.top
- **状态**: ✅ 已启用
- **支持模型**:
  - `claude-sonnet-4-5-20250929` - $0.05/次
  - `claude-opus-4-5-20251101` - $0.15/次

### 2. OpenAI (优先级: 90)
- **API地址**: https://api.aiyunos.top
- **状态**: ⏸️ 待配置
- **支持模型**:
  - `gpt-5` - $0.03/次
  - `gpt-5.1` - $0.03/次

### 3. 通义千问 Qwen (优先级: 80)
- **API地址**: https://api.aiyunos.top/v1
- **状态**: ⏸️ 待配置
- **支持模型**:
  - `qwen-max` - $0.02/次

### 4. Moonshot Kimi (优先级: 70)
- **API地址**: https://api.aiyunos.top/v1
- **状态**: ⏸️ 待配置
- **支持模型**:
  - `moonshot-v1-8k` - $0.02/次

### 5. 字节豆包 Doubao (优先级: 60)
- **API地址**: https://api.aiyunos.top/v1
- **状态**: ⏸️ 待配置
- **支持模型**:
  - `doubao-pro-4k` - $0.02/次

### 6. xAI Grok (优先级: 55) ⭐ 新增
- **API地址**: https://api.aiyunos.top
- **状态**: ⏸️ 待配置
- **支持模型**:
  - `grok-4` - $0.015/次 (最便宜)
  - `grok-4.1` - $0.015/次 (最便宜)

### 7. Google Gemini (优先级: 50)
- **API地址**: https://api.aiyunos.top
- **状态**: ⏸️ 待配置
- **支持模型**:
  - `gemini-2.5-pro-exp-03-25` - $0.025/次
  - `gemini-3-pro` - $0.025/次

---

## ⚙️ 网页配置步骤

### 方式1: 使用AI提供商管理页面（推荐）

1. **打开浏览器访问**
   ```
   http://120.232.235.142:3001
   ```

2. **进入AI提供商管理页面**
   - 点击顶部导航栏的 **"🤖 AI提供商"** Tab

3. **配置每个提供商**
   - 点击提供商卡片上的 **"配置"** 按钮
   - 在弹出的模态框中：
     - **API密钥**: 输入您的 API KEY
     - **优先级**: 保持默认值（或根据需要调整）
     - **启用此提供商**: 勾选此选项
   - 点击 **"保存配置"**
   - 可选：点击 **"测试连接"** ���证配置是否正确

4. **推荐配置策略**

   **策略A: 成本优先**
   ```
   1. Grok (grok-4) - $0.015/次 ✅ 启用，优先级: 100
   2. Gemini (gemini-3-pro) - $0.025/次 ✅ 启用，优先级: 90
   3. OpenAI (gpt-5) - $0.03/次 ✅ 启用，优先级: 80
   其他: 禁用
   ```

   **策略B: 质量优先**
   ```
   1. Claude (claude-sonnet-4-5) - $0.05/次 ✅ 启用，优先级: 100
   2. GPT-5.1 - $0.03/次 ✅ 启用，优先级: 90
   3. Grok-4.1 - $0.015/次 ✅ 启用，优先级: 80
   其他: 禁用
   ```

   **策略C: 平衡策略（推荐）**
   ```
   1. Claude Sonnet - $0.05/次 ✅ 启用，优先级: 100
   2. GPT-5 - $0.03/次 ✅ 启用，优先级: 90
   3. Grok-4 - $0.015/次 ✅ 启用，优先级: 80
   4. Gemini 3 Pro - $0.025/次 ✅ 启用，优先级: 70
   其他: 备用（根据需要启用）
   ```

### 方式2: 使用命令行配置

如果您更喜欢命令行，可以直接修改数据库：

```bash
# 进入数据库
sqlite3 /home/user/xhs/data/knowledge.db

# 配置OpenAI（将YOUR_API_KEY替换为实际密钥）
UPDATE ai_providers
SET api_key_encrypted = 'YOUR_ENCRYPTED_KEY', is_enabled = 1
WHERE provider = 'openai';

# 启用Grok
UPDATE ai_providers
SET api_key_encrypted = 'YOUR_ENCRYPTED_KEY', is_enabled = 1
WHERE provider = 'grok';

# 查看配置
SELECT provider, is_enabled, priority FROM ai_providers ORDER BY priority DESC;

# 退出
.quit
```

**注意**: API密钥需要加密存储，建议使用网页界面配置（自动加密）。

---

## 🔄 智能故障转移机制

系统支持自动故障转移：

1. **优先级调度**: 按优先级顺序调用AI提供商
2. **自动重试**: 如果高优先级提供商失败，自动尝试下一个
3. **使用日志**: 记录每次调用的提供商、模型、耗时、成本
4. **统计分析**: 在"📊 发布历史"页面查看AI使用统计

---

## 📊 价格对比

| 提供商 | 模型 | 单价/次 | 性价比 |
|--------|------|---------|--------|
| Grok | grok-4 | $0.015 | ⭐⭐⭐⭐⭐ |
| Grok | grok-4.1 | $0.015 | ⭐⭐⭐⭐⭐ |
| Qwen | qwen-max | $0.02 | ⭐⭐⭐⭐ |
| Kimi | moonshot-v1-8k | $0.02 | ⭐⭐⭐⭐ |
| Doubao | doubao-pro-4k | $0.02 | ⭐⭐⭐⭐ |
| Gemini | gemini-2.5-pro | $0.025 | ⭐⭐⭐⭐ |
| Gemini | gemini-3-pro | $0.025 | ⭐⭐⭐⭐ |
| OpenAI | gpt-5 | $0.03 | ⭐⭐⭐ |
| OpenAI | gpt-5.1 | $0.03 | ⭐⭐⭐ |
| Claude | sonnet-4-5 | $0.05 | ⭐⭐⭐ |
| Claude | opus-4-5 | $0.15 | ⭐⭐ |

**推荐**: 启用Grok和Gemini作为主力，Claude Sonnet作为高质量备选。

---

## ✅ 验证配置

### 测试单个提供商

1. 在AI提供商页面点击 **"测试连接"**
2. 系统会发送测试请求验证配置
3. 显示连接成功和延迟时间

### 测试实际使用

1. 进入 **"生成文案"** Tab
2. 选择产品和配置
3. 在 **"AI模型"** 下拉菜单中查看可用模型
4. 生成一条测试文案
5. 在 **"📊 发布历史"** 查看使用的提供商和成本

---

## 🔧 高级配置

### 调整优先级

优先级决定调用顺序（数字越大优先级越高）：

```
100 = 最高优先级（总是先尝试）
90 = 高优先级（第一个失败时使用）
80 = 中优先级
...
50 = 低优先级
```

### 调整超时时间

默认超时: 60秒

如果需要调整，在配置模态框中修改或直接更新数据库：
```sql
UPDATE ai_providers SET timeout = 30000 WHERE provider = 'grok';
```

### 清除缓存

提供商配置会缓存5分钟，如果修改后未生效：

1. 点击 **"清除缓存"** 按钮
2. 或重启服务器

---

## 🐛 故障排查

### 问题1: 提供商显示"未配置"

**解决方法**:
1. 检查API密钥是否正确填写
2. 确保勾选了"启用此提供商"
3. 点击"测试连接"验证

### 问题2: 测试连接失败

**可能原因**:
- API密钥错误
- 代理服务地址错误
- 网络问题
- API额度不足

**解决方法**:
1. 验证API密钥是否正确
2. 确认代理服务是否正常运行

### 问题3: 生成文案时没有可用模型

**解决方法**:
1. 至少启用一个提供商
2. 确保提供商已配置API密钥
3. 刷新页面重新加载模型列表

### 问题4: 所有提供商都失败

**检查项**:
1. 查看"📊 发布历史"的错误信息
2. 检查网络连接
3. 查看服务器日志: `tail -f /tmp/xhs-server.log`

---

## 📝 API使用记录

所有AI调用都会记录在数据库中：

### 查看使用记录

```bash
sqlite3 /home/user/xhs/data/knowledge.db

# 查看最近10次调用
SELECT
  provider,
  model,
  success,
  tokens_used,
  cost,
  duration_ms,
  created_at
FROM ai_usage_logs
ORDER BY created_at DESC
LIMIT 10;
```

### 查看成本统计

在网页的 **"📊 发布历史"** Tab中：
- 查看总调用次数
- 查看成功率
- 查看总成本
- 按提供商分析使用情况

---

## 🎯 最佳实践

1. **启用3-4个提供商作为备份**
   - 避免单点故障
   - 提高系统可用性

2. **按成本和质量设置优先级**
   - 日常使用：低成本提供商优先
   - 重要内容：高质量提供商优先

3. **定期检查使用统计**
   - 监控成本
   - 优化提供商选择

4. **测试每个提供商**
   - 确保配置正确
   - 了解各提供商的特点

---

## 📞 获取帮助

- **查看日志**: `tail -f /tmp/xhs-server.log`
- **API文档**: 查看 `API_DOCUMENTATION.md`
- **系统状态**: 访问 http://120.232.235.142:3001/api/health

---

**配置完成时间**: 2026-01-13
**服务器地址**: http://120.232.235.142:3001
**状态**: ✅ 就绪
