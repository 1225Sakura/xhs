/**
 * å¤šè´¦æˆ·å°çº¢ä¹¦å‘å¸ƒæœåŠ¡
 * ä½¿ç”¨ Playwright ç›´æ¥æ§åˆ¶æµè§ˆå™¨å‘å¸ƒ
 */

import { chromium } from 'playwright';
import accountManagementService from './accountManagementService.js';
import path from 'path';
import fs from 'fs';
import fsp from 'fs/promises';

class MultiAccountPublishService {
  /**
   * å‘å¸ƒç¬”è®°åˆ°å°çº¢ä¹¦
   */
  async publishNote(title, content, images = [], accountId = null) {
    let browser = null;

    try {
      // å¦‚æœæ²¡æœ‰æŒ‡å®šè´¦æˆ·ï¼Œä½¿ç”¨å½“å‰æ´»è·ƒè´¦æˆ·
      if (!accountId) {
        const activeAccount = accountManagementService.getActiveAccount();
        if (!activeAccount) {
          return {
            success: false,
            error: 'è¯·å…ˆåˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªè´¦æˆ·'
          };
        }
        accountId = activeAccount.id;
      }

      // è·å–è´¦æˆ·ä¿¡æ¯
      const account = accountManagementService.getAccountById(accountId);
      if (!account) {
        return {
          success: false,
          error: 'è´¦æˆ·ä¸å­˜åœ¨'
        };
      }

      if (!account.is_logged_in) {
        return {
          success: false,
          error: 'è´¦æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•'
        };
      }

      // éªŒè¯ cookies æ˜¯å¦æœ‰æ•ˆï¼ˆæ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼‰
      const cookies = accountManagementService.getAccountCookies(accountId);
      if (!cookies) {
        // æ›´æ–°ç™»å½•çŠ¶æ€ä¸ºæœªç™»å½•
        accountManagementService.updateLoginStatus(accountId, false, null);
        return {
          success: false,
          error: 'è´¦æˆ· cookies æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•'
        };
      }

      // æ£€æŸ¥ cookies æ˜¯å¦è¿‡æœŸ
      const now = Date.now() / 1000;
      const expiredCookies = cookies.filter(cookie => {
        if (cookie.expires && cookie.expires > 0) {
          return cookie.expires < now;
        }
        return false;
      });

      if (expiredCookies.length > 0) {
        console.log(`âš ï¸ å‘ç° ${expiredCookies.length} ä¸ªè¿‡æœŸçš„ cookies`);
        // æ›´æ–°ç™»å½•çŠ¶æ€ä¸ºæœªç™»å½•
        accountManagementService.updateLoginStatus(accountId, false, null);
        return {
          success: false,
          error: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'
        };
      }

      console.log(`ğŸš€ å¼€å§‹ä¸ºè´¦æˆ· ${account.account_name} (ID: ${accountId}) å‘å¸ƒç¬”è®°...`);
      console.log('ğŸ“ æ ‡é¢˜:', title);
      console.log('ğŸ“ å†…å®¹é•¿åº¦:', content.length);
      console.log('ğŸ–¼ï¸ å›¾ç‰‡æ•°é‡:', images.length);

      // å¯åŠ¨æµè§ˆå™¨
      browser = await chromium.launch({
        headless: false,
        args: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-blink-features=AutomationControlled',
          '--disable-dev-shm-usage',
        ],
      });

      const context = await browser.newContext({
        userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        viewport: { width: 1920, height: 1080 },
        locale: 'zh-CN',
      });

      // éšè— webdriver ç‰¹å¾
      await context.addInitScript(() => {
        Object.defineProperty(navigator, 'webdriver', {
          get: () => undefined,
        });
      });

      // åŠ è½½è´¦æˆ·çš„ cookiesï¼ˆå·²åœ¨å‰é¢éªŒè¯è¿‡æœ‰æ•ˆæ€§ï¼‰
      console.log('ğŸª åŠ è½½è´¦æˆ· cookies...');
      await context.addCookies(cookies);

      const page = await context.newPage();

      // è®¿é—®åˆ›ä½œè€…ä¸­å¿ƒé¦–é¡µï¼ˆä¸æ˜¯ç›´æ¥è®¿é—®å‘å¸ƒé¡µé¢ï¼‰
      console.log('ğŸ“„ è®¿é—®åˆ›ä½œè€…ä¸­å¿ƒ...');
      await page.goto('https://creator.xiaohongshu.com', {
        waitUntil: 'networkidle',
        timeout: 60000
      });

      // ç­‰å¾…é¡µé¢åŠ è½½
      await page.waitForTimeout(3000);

      // æ£€æŸ¥æ˜¯å¦éœ€è¦ç™»å½•
      let currentUrl = page.url();
      if (currentUrl.includes('login')) {
        await browser.close();
        return {
          success: false,
          error: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'
        };
      }

      // ç‚¹å‡»"å‘å¸ƒç¬”è®°"æŒ‰é’®æ‰“å¼€å‘å¸ƒå¼¹çª—
      console.log('ğŸ“ ç‚¹å‡»å‘å¸ƒç¬”è®°æŒ‰é’®...');
      const publishSelectors = [
        '.publish-video .btn',
        'button:has-text("å‘å¸ƒç¬”è®°")',
        '.btn:has-text("å‘å¸ƒç¬”è®°")',
        'text=å‘å¸ƒç¬”è®°'
      ];

      let publishClicked = false;
      for (const selector of publishSelectors) {
        try {
          console.log(`å°è¯•å‘å¸ƒæŒ‰é’®é€‰æ‹©å™¨: ${selector}`);
          await page.waitForSelector(selector, { timeout: 5000 });
          await page.click(selector);
          console.log(`âœ… æˆåŠŸç‚¹å‡»å‘å¸ƒæŒ‰é’®: ${selector}`);
          publishClicked = true;
          break;
        } catch (e) {
          console.log(`å‘å¸ƒæŒ‰é’®é€‰æ‹©å™¨ ${selector} å¤±è´¥`);
        }
      }

      if (!publishClicked) {
        const screenshotPath = path.join(process.cwd(), 'data', 'temp', `no-publish-button-${Date.now()}.png`);
        await fsp.mkdir(path.dirname(screenshotPath), { recursive: true });
        await page.screenshot({ path: screenshotPath, fullPage: true });
        console.log('ğŸ“¸ æœªæ‰¾åˆ°å‘å¸ƒæŒ‰é’®ï¼Œå·²ä¿å­˜æˆªå›¾:', screenshotPath);

        await browser.close();
        return {
          success: false,
          error: 'æœªæ‰¾åˆ°å‘å¸ƒæŒ‰é’®'
        };
      }

      await page.waitForTimeout(3000);

      // åˆ‡æ¢åˆ°å›¾æ–‡tabï¼ˆç¬¬äºŒä¸ªtabï¼‰
      console.log('ğŸ”„ åˆ‡æ¢åˆ°å›¾æ–‡å‘å¸ƒæ¨¡å¼...');
      try {
        // ç­‰å¾…tabåŠ è½½
        await page.waitForSelector('.creator-tab', { timeout: 10000 });

        // ä½¿ç”¨JavaScriptç‚¹å‡»ç¬¬äºŒä¸ªtab
        const tabClicked = await page.evaluate(() => {
          const tabs = document.querySelectorAll('.creator-tab');
          if (tabs.length > 1) {
            tabs[1].click();
            return true;
          }
          return false;
        });

        if (tabClicked) {
          console.log('âœ… å·²åˆ‡æ¢åˆ°å›¾æ–‡tab');
          await page.waitForTimeout(2000);
        } else {
          console.warn('âš ï¸ æœªæ‰¾åˆ°å›¾æ–‡tab');
        }
      } catch (error) {
        console.warn('âš ï¸ åˆ‡æ¢å›¾æ–‡tabæ—¶å‡ºé”™:', error.message);
      }

      // ç­‰å¾…é¡µé¢åˆ‡æ¢å®Œæˆ
      await page.waitForTimeout(3000);

      // ä¸Šä¼ å›¾ç‰‡
      if (images && images.length > 0) {
        console.log(`ğŸ“· ä¸Šä¼  ${images.length} å¼ å›¾ç‰‡...`);
        let inputUpload = await page.$('input[type="file"]');
        if (inputUpload) {
          // å°†å›¾ç‰‡è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
          const absoluteImages = images.map(img => {
            // å¦‚æœå·²ç»æ˜¯ç»å¯¹è·¯å¾„ï¼ˆWindows: C:\... æˆ– Linux: /home/...ï¼‰
            if (path.isAbsolute(img) && !img.startsWith('/app/') && !img.startsWith('/uploads/')) {
              return img;
            }

            // å¤„ç† MCP å®¹å™¨è·¯å¾„ /app/uploads/...
            if (img.startsWith('/app/uploads/')) {
              return path.join(process.cwd(), img.replace('/app/', ''));
            }

            // å¤„ç†ç›¸å¯¹è·¯å¾„ /uploads/...
            if (img.startsWith('/uploads/')) {
              return path.join(process.cwd(), img.substring(1)); // ç§»é™¤å¼€å¤´çš„ /
            }

            // å¤„ç†ç›¸å¯¹è·¯å¾„ uploads/...
            if (img.startsWith('uploads/')) {
              return path.join(process.cwd(), img);
            }

            // å…¶ä»–æƒ…å†µï¼Œå‡è®¾æ˜¯ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•
            return path.join(process.cwd(), img);
          });

          console.log('ğŸ“‚ è½¬æ¢åçš„å›¾ç‰‡è·¯å¾„:', absoluteImages);

          // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          for (const imgPath of absoluteImages) {
            if (!fs.existsSync(imgPath)) {
              console.error(`âŒ å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: ${imgPath}`);
              await browser.close();
              return {
                success: false,
                error: `å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: ${imgPath}`
              };
            }
          }

          // æ£€æŸ¥ input æ˜¯å¦æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ 
          const hasMultiple = await inputUpload.evaluate(el => el.hasAttribute('multiple'));

          if (hasMultiple || absoluteImages.length === 1) {
            // æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œæˆ–åªæœ‰ä¸€ä¸ªæ–‡ä»¶
            await inputUpload.setInputFiles(absoluteImages);
            console.log('âœ… å›¾ç‰‡ä¸Šä¼ å®Œæˆ');
          } else {
            // ä¸æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œéœ€è¦é€ä¸ªä¸Šä¼ 
            console.log('âš ï¸ æ£€æµ‹åˆ°å•æ–‡ä»¶ä¸Šä¼ æ§ä»¶ï¼Œå°è¯•é€ä¸ªä¸Šä¼ ...');
            for (let i = 0; i < absoluteImages.length; i++) {
              console.log(`ğŸ“¤ ä¸Šä¼ ç¬¬ ${i + 1}/${absoluteImages.length} å¼ å›¾ç‰‡...`);
              await inputUpload.setInputFiles([absoluteImages[i]]);
              await page.waitForTimeout(1000);

              // å¦‚æœè¿˜æœ‰æ›´å¤šå›¾ç‰‡ï¼Œéœ€è¦å†æ¬¡æ‰¾åˆ° input å…ƒç´ ï¼ˆå¯èƒ½å·²ç»è¢«æ›¿æ¢ï¼‰
              if (i < absoluteImages.length - 1) {
                const nextInput = await page.$('input[type="file"]');
                if (nextInput) {
                  inputUpload = nextInput;
                } else {
                  console.warn('âš ï¸ æ— æ³•æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ æ§ä»¶');
                  break;
                }
              }
            }
            console.log('âœ… æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å®Œæˆ');
          }

          // ç­‰å¾…å›¾ç‰‡å¤„ç†
          await page.waitForTimeout(3000);
        }
      }

      // å¡«å†™æ ‡é¢˜
      console.log('âœï¸ å¡«å†™æ ‡é¢˜...');
      const titleInput = await page.$('input[placeholder*="å¡«å†™æ ‡é¢˜"], input[placeholder*="æ ‡é¢˜"]');
      if (titleInput) {
        await titleInput.fill(title);
      }

      // å¡«å†™å†…å®¹
      console.log('âœï¸ å¡«å†™å†…å®¹...');
      const contentArea = await page.$('div[contenteditable="true"]');
      if (contentArea) {
        await titleInput.fill(content);
      }

      // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿å†…å®¹å¡«å†™å®Œæˆ
      await page.waitForTimeout(2000);

      // ç‚¹å‡»å‘å¸ƒæŒ‰é’®
      console.log('ğŸ“¤ ç‚¹å‡»å‘å¸ƒ...');

      // å°è¯•å¤šç§æ–¹å¼æŸ¥æ‰¾å‘å¸ƒæŒ‰é’®
      let publishButton = await page.$('button:has-text("å‘å¸ƒ")');
      if (!publishButton) {
        publishButton = await page.$('button[type="submit"]');
      }
      if (!publishButton) {
        publishButton = await page.$('.publish-btn, .submit-btn, [class*="publish"], [class*="submit"]');
      }

      if (publishButton) {
        await publishButton.click();
        console.log('âœ… å·²ç‚¹å‡»å‘å¸ƒæŒ‰é’®');
      } else {
        // æˆªå›¾ä»¥ä¾¿è°ƒè¯•
        const screenshotPath = path.join(process.cwd(), 'data', 'temp', `no-button-${Date.now()}.png`);
        await fsp.mkdir(path.dirname(screenshotPath), { recursive: true });
        await page.screenshot({ path: screenshotPath, fullPage: true });
        console.log('ğŸ“¸ æœªæ‰¾åˆ°å‘å¸ƒæŒ‰é’®ï¼Œå·²ä¿å­˜æˆªå›¾:', screenshotPath);

        await browser.close();
        return {
          success: false,
          error: 'æœªæ‰¾åˆ°å‘å¸ƒæŒ‰é’®'
        };
      }

      // ç­‰å¾…å‘å¸ƒå®Œæˆ - æ£€æŸ¥æˆåŠŸæ ‡è¯†
      console.log('â³ ç­‰å¾…å‘å¸ƒå®Œæˆ...');
      try {
        // ç­‰å¾…æˆåŠŸæç¤ºæˆ–é¡µé¢è·³è½¬ï¼ˆæœ€å¤šç­‰å¾…30ç§’ï¼‰
        await Promise.race([
          page.waitForSelector('text=å‘å¸ƒæˆåŠŸ', { timeout: 30000 }),
          page.waitForSelector('.success', { timeout: 30000 }),
          page.waitForURL(/.*\/publish\/success.*/, { timeout: 30000 })
        ]);

        console.log('âœ… å‘å¸ƒæˆåŠŸï¼');
        await browser.close();
        return {
          success: true,
          data: {
            message: 'å‘å¸ƒæˆåŠŸ',
            account_id: accountId,
            account_name: account.account_name
          }
        };
      } catch (waitError) {
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æˆåŠŸæ ‡è¯†ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æç¤º
        const errorElement = await page.$('.error, .error-message, [class*="error"]');
        if (errorElement) {
          const errorText = await errorElement.textContent();
          await browser.close();
          return {
            success: false,
            error: `å‘å¸ƒå¤±è´¥: ${errorText}`
          };
        }

        // æˆªå›¾ä¿å­˜ä»¥ä¾¿è°ƒè¯•
        const screenshotPath = path.join(process.cwd(), 'data', 'temp', `publish-error-${Date.now()}.png`);
        await fsp.mkdir(path.dirname(screenshotPath), { recursive: true });
        await page.screenshot({ path: screenshotPath, fullPage: true });
        console.log('ğŸ“¸ å·²ä¿å­˜æˆªå›¾:', screenshotPath);

        await browser.close();
        return {
          success: false,
          error: 'å‘å¸ƒè¶…æ—¶æˆ–æœªæ£€æµ‹åˆ°æˆåŠŸæ ‡è¯†ï¼Œè¯·æ£€æŸ¥æˆªå›¾'
        };
      }

    } catch (error) {
      console.error('âŒ å‘å¸ƒå¤±è´¥:', error);
      if (browser) {
        await browser.close();
      }
      return {
        success: false,
        error: error.message
      };
    }
  }
}

export default new MultiAccountPublishService();
