# 项目规则文档

## 📜 项目死规则

本文档定义了项目开发和维护过程中**必须严格遵守**的规则，任何情况下都不能违反。

---

## 0. AI 交互执行规则 ⚠️

### 0.1 提问确认规则
**规则：** 在执行任何任务时，AI 必须对所有不确定的问题、决策点、实现方案先提问，等待用户明确回答后才能执行。

**强制要求：**
- ✅ 任务开始前必须明确需求和期望结果
- ✅ 遇到多种实现方案时必须询问用户偏好
- ✅ 发现潜在问题或风险时必须提前告知
- ✅ 需要修改关键配置或代码时必须征得同意
- ✅ 不确定用户意图时必须澄清而不是猜测
- ❌ 禁止在未确认的情况下自行决策
- ❌ 禁止假设用户的需求或偏好
- ❌ 禁止跳过重要的确认步骤

**提问原则：**
1. **明确性** - 问题要具体明确，避免模糊不清
2. **完整性** - 一次性提出所有关键问题，避免反复询问
3. **选项化** - 提供具体的选项供用户选择，而不是开放式问题
4. **优先级** - 先问最重要的问题，按优先级排序
5. **上下文** - 提供足够的背景信息帮助用户做决策

**示例场景：**
- 修复 bug 时有多种方案 → 列出方案优缺点，询问选择
- 需要安装新依赖 → 说明依赖用途和影响，征求同意
- 代码结构需要重构 → 说明重构范围和风险，确认是否执行
- 配置文件需要修改 → 说明修改内容和影响，等待确认
- 发现代码中的潜在问题 → 指出问题，询问是否一并修复

### 0.2 执行反馈规则
**规则：** 执行任务时必须及时反馈进度和结果。

**强制要求：**
- ✅ 开始执行前说明将要做什么
- ✅ 执行过程中报告关键步骤
- ✅ 完成后总结执行结果
- ✅ 遇到错误时立即报告并询问如何处理
- ❌ 禁止静默执行不报告进度
- ❌ 禁止隐藏执行过程中的错误或警告

### 0.3 任务验证规则
**规则：** 任务完成后必须验证结果是否符合预期。

**强制要求：**
- ✅ 代码修改后必须测试功能是否正常
- ✅ 配置修改后必须验证配置是否生效
- ✅ 文件操作后必须确认文件状态正确
- ✅ 发现问题时必须报告并询问如何处理
- ❌ 禁止假设修改一定成功
- ❌ 禁止跳过验证步骤

---

## 2. 文件组织规则

### 2.1 目录结构规则
**规则：** 所有文件必须按照功能模块分类存放，禁止在根目录堆积文件。

**强制要求：**
- ✅ 源代码必须放在 `src/` 目录
- ✅ 前端文件必须放在 `public/` 目录
- ✅ 脚本文件必须放在 `scripts/` 及其子目录
- ✅ 文档文件必须放在 `docs/` 及其子目录
- ✅ 数据文件必须放在 `data/` 目录
- ✅ 上传文件必须放在 `uploads/` 目录
- ❌ 禁止在根目录创建临时文件或测试文件
- ❌ 禁止在根目录堆积脚本文件

### 2.2 脚本分类规则
**规则：** 所有脚本必须按用途分类存放。

**分类标准：**
- `scripts/startup/` - 启动和停止脚本
- `scripts/utils/` - 工具和辅助脚本
- `scripts/tests/` - 测试脚本
- `scripts/` - 核心自动化脚本

**禁止行为：**
- ❌ 禁止将测试脚本放在根目录
- ❌ 禁止将临时调试脚本提交到版本库
- ❌ 禁止创建功能重复的脚本

---

## 3. 文档管理规则

### 3.1 MD 文件数量限制
**规则：** 严格控制 MD 文件数量，避免文档泛滥。

**根目录 MD 文件（最多 3 个）：**
1. `README.md` - 项目介绍和快速开始
2. `PROGRESS.md` - 任务进度跟踪
3. `RULES.md` - 项目规则（本文档）

**禁止行为：**
- ❌ 禁止在根目录创建其他 MD 文件
- ❌ 禁止为每个任务创建单独的 MD 文件
- ❌ 禁止创建临时的分析或修复文档

### 3.2 文档更新规则
**规则：** 优先更新现有文档，而不是创建新文档。

**强制要求：**
- ✅ 任务完成后更新 `PROGRESS.md`，不创建新文档
- ✅ 问题修复后更新相关文档，不创建修复报告
- ✅ 功能变更后更新 `README.md`，不创建变更日志
- ❌ 禁止为单次任务创建专门的文档

### 3.3 文档分类规则
**规则：** docs/ 目录下的文档必须分类存放。

**分类标准：**
- `docs/api/` - API 接口文档
- `docs/guides/` - 使用指南和教程
- `docs/setup/` - 配置和部署指南
- `docs/reports/` - 项目报告
- `docs/status/` - 状态和验证文档
- `docs/archive/` - 历史文档归档

**归档规则：**
- 过时的分析文档 → `docs/archive/`
- 历史修复报告 → `docs/archive/`
- 临时状态文档 → `docs/archive/`

---

## 4. 代码规范规则

### 4.1 模块化规则
**规则：** 后端代码必须遵循 Controller-Service-Model 架构。

**强制要求：**
- ✅ 控制器层（Controller）只处理请求和响应
- ✅ 服务层（Service）处理业务逻辑
- ✅ 模型层（Model）处理数据访问
- ❌ 禁止在控制器中编写业务逻辑
- ❌ 禁止在服务层直接操作 HTTP 请求

### 4.2 命名规范
**规则：** 文件和变量命名必须清晰、一致。

**命名标准：**
- 文件名：小驼峰命名（camelCase）
- 类名：大驼峰命名（PascalCase）
- 变量名：小驼峰命名（camelCase）
- 常量名：全大写下划线分隔（UPPER_SNAKE_CASE）
- 数据库表名：小写下划线分隔（snake_case）

### 4.3 错误处理规则
**规则：** 所有 API 必须统一错误处理格式。

**响应格式：**
```javascript
// 成功响应
{ success: true, data: {...} }

// 错误响应
{ success: false, error: "错误信息" }
```

**禁止行为：**
- ❌ 禁止直接抛出未捕获的异常
- ❌ 禁止返回不一致的响应格式
- ❌ 禁止在响应中暴露敏感信息

---

## 5. 版本控制规则

### 5.1 提交规则
**规则：** Git 提交必须遵循规范的提交信息格式。

**提交格式：**
```
<type>: <subject>

<body>

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

**Type 类型：**
- `feat` - 新功能
- `fix` - 修复 bug
- `docs` - 文档更新
- `style` - 代码格式调整
- `refactor` - 代码重构
- `test` - 测试相关
- `chore` - 构建或辅助工具变动

### 5.2 忽略文件规则
**规则：** 必须正确配置 .gitignore，避免提交不必要的文件。

**必须忽略：**
- `node_modules/` - 依赖包
- `.env` - 环境变量（包含敏感信息）
- `data/*.db` - 数据库文件
- `logs/` - 日志文件
- `temp_*/` - 临时目录
- `*.log` - 日志文件
- `backups/` - 备份文件

**禁止行为：**
- ❌ 禁止提交 .env 文件
- ❌ 禁止提交 node_modules
- ❌ 禁止提交临时文件和调试文件

---

## 6. 环境配置规则

### 6.1 环境变量规则
**规则：** 所有敏感配置必须通过环境变量管理。

**强制要求：**
- ✅ API 密钥必须存储在 .env 文件
- ✅ 数据库路径必须通过环境变量配置
- ✅ 服务端口必须可配置
- ✅ 必须提供 .env.example 作为模板
- ❌ 禁止在代码中硬编码敏感信息
- ❌ 禁止提交包含真实密钥的 .env 文件

### 6.2 依赖管理规则
**规则：** 依赖包必须通过 package.json 管理。

**强制要求：**
- ✅ 新增依赖必须记录在 package.json
- ✅ 必须提交 package-lock.json 锁定版本
- ✅ 定期更新依赖包的安全补丁
- ❌ 禁止手动修改 node_modules
- ❌ 禁止提交 node_modules 到版本库

---

## 7. 测试规则

### 7.1 测试覆盖规则
**规则：** 核心功能必须有测试覆盖。

**必须测试的功能：**
- API 接口完整性测试
- 发布功能测试
- 数据库操作测试
- AI 服务集成测试

### 7.2 测试脚本规则
**规则：** 测试脚本必须可重复执行，不影响生产数据。

**强制要求：**
- ✅ 测试必须使用测试数据库或 mock 数据
- ✅ 测试脚本必须可以独立运行
- ❌ 禁止测试脚本修改生产数据
- ❌ 禁止测试脚本依赖特定的运行顺序

---

## 8. 安全规则

### 8.1 敏感信息规则
**规则：** 严格保护敏感信息，防止泄露。

**禁止行为：**
- ❌ 禁止在代码中硬编码密码、密钥
- ❌ 禁止在日志中输出敏感信息
- ❌ 禁止在错误信息中暴露系统细节
- ❌ 禁止提交包含真实 cookies 的文件

### 8.2 API 安全规则
**规则：** API 必须进行适当的验证和授权。

**强制要求：**
- ✅ 输入参数必须验证
- ✅ 文件上传必须限制类型和大小
- ✅ 数据库查询必须防止 SQL 注入
- ❌ 禁止信任未验证的用户输入

---

## 9. 维护规则

### 9.1 日志规则
**规则：** 合理使用日志，便于问题排查。

**日志级别：**
- `ERROR` - 错误信息（必须记录）
- `WARN` - 警告信息
- `INFO` - 重要操作信息
- `DEBUG` - 调试信息（生产环境关闭）

**禁止行为：**
- ❌ 禁止在循环中大量输出日志
- ❌ 禁止在日志中输出敏感信息
- ❌ 禁止使用 console.log 代替正规日志

### 9.2 备份规则
**规则：** 重要数据必须定期备份。

**备份要求：**
- ✅ 数据库每日自动备份
- ✅ 备份文件保留 7 天
- ✅ 备份文件存储在 backups/ 目录
- ✅ 定期验证备份可恢复性

---

## 10. 协作规则

### 10.1 代码审查规则
**规则：** 重要变更必须经过审查。

**审查要点：**
- 代码是否符合规范
- 是否有安全隐患
- 是否有性能问题
- 文档是否更新

### 10.2 沟通规则
**规则：** 重要决策必须记录和沟通。

**强制要求：**
- ✅ 架构变更必须提前讨论
- ✅ 破坏性变更必须提前通知
- ✅ 重要决策必须记录在文档中

---

## 11. 规则更新

### 11.1 规则修改流程
**规则：** 规则的修改必须经过审慎考虑。

**修改流程：**
1. 提出规则修改建议
2. 讨论修改的必要性和影响
3. 达成共识后更新本文档
4. 通知所有相关人员

### 11.2 规则执行
**规则：** 所有规则必须严格执行，违反规则必须立即纠正。

**执行原则：**
- 规则面前人人平等
- 发现违规立即指出
- 重复违规必须追责
- 规则执行情况定期检查

---

## 📝 规则变更历史

### 2026-01-30 (v1.1)
- **新增第 0 条规则**：AI 交互执行规则
  - 添加提问确认规则：要求 AI 在执行前必须提问确认
  - 添加执行反馈规则：要求及时反馈进度和结果
  - 添加任务验证规则：要求完成后验证结果
- 更新规则编号：原 1-10 条规则更新为 2-11 条
- 强化交互式开发流程

### 2026-01-30 (v1.0)
- 创建项目规则文档
- 定义 10 大类规则
- 明确文件组织、文档管理、代码规范等核心规则

---

**最后更新：** 2026-01-30
**文档版本：** 1.1
**维护者：** 项目团队

---

## ⚠️ 重要提醒

本文档定义的规则是项目的**死规则**，任何情况下都必须严格遵守。违反规则将导致：
- 代码质量下降
- 项目结构混乱
- 协作效率降低
- 安全风险增加

请所有项目参与者认真阅读并严格执行本规则文档！
